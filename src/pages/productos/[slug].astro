---
import PublicLayout from "../../layouts/PublicLayout.astro";
import ProductDetail from "../../components/islands/ProductDetail";
import FavoriteButton from "../../components/islands/FavoriteButton";
import CloudinaryImage from "../../components/common/CloudinaryImage.astro";
import { supabase } from "../../lib/supabase";
import { formatPrice } from "../../lib/utils";

export async function getStaticPaths() {
  const { data: products } = await supabase.from("products").select("slug");

  if (!products || products.length === 0) {
    return [{ params: { slug: "placeholder" } }];
  }

  return products.map((product) => ({
    params: { slug: product.slug },
  }));
}

const { slug } = Astro.params;

const { data: product } = await supabase
  .from("products")
  .select("*, categories(name)")
  .eq("slug", slug)
  .single();

if (!product) {
  return Astro.redirect("/productos");
}

const p = product;

// Obtener imágenes adicionales para galería
const mainImage =
  p.images?.[0] ||
  "https://images.unsplash.com/photo-1594932224010-756643c71df5?q=80&w=800";
const additionalImages = p.images?.slice(1) || [];

// Mostrar precio de oferta si está en oferta
const displayPrice = p.is_on_sale && p.sale_price ? p.sale_price : p.price;
const originalPrice = p.is_on_sale && p.sale_price ? p.price : null;
---

<PublicLayout title={p.name}>
  <div class="max-w-7xl mx-auto px-6 py-12">
    <!-- Breadcrumb -->
    <nav
      class="flex text-xs uppercase tracking-widest text-slate-400 mb-12 space-x-2"
    >
      <a href="/" class="hover:text-brand-navy transition-colors">Inicio</a>
      <span>/</span>
      <a href="/productos" class="hover:text-brand-navy transition-colors"
        >Catálogo</a
      >
      <span>/</span>
      <span class="text-brand-navy font-bold">{p.categories?.name}</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
      <!-- Galería de imágenes -->
      <div class="space-y-4">
        <div class="aspect-[3/4] bg-slate-100 overflow-hidden relative group">
          <CloudinaryImage
            src={mainImage}
            alt={p.name}
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
            priority={true}
          />
          {
            p.is_on_sale && (
              <span class="absolute top-4 left-4 bg-red-500 text-white px-3 py-1 text-xs font-bold uppercase tracking-wider">
                Oferta
              </span>
            )
          }
        </div>

        {
          additionalImages.length > 0 && (
            <div class="grid grid-cols-4 gap-2">
              {additionalImages.map((img: string, idx: number) => (
                <div class="aspect-square bg-slate-100 overflow-hidden cursor-pointer hover:opacity-80 transition-opacity">
                  <CloudinaryImage
                    src={img}
                    alt={`${p.name} - Imagen ${idx + 2}`}
                    class="w-full h-full object-cover"
                  />
                </div>
              ))}
            </div>
          )
        }
      </div>

      <!-- Información del producto -->
      <div class="flex flex-col justify-center">
        <div class="mb-8 border-b border-slate-100 pb-8">
          <div class="flex items-start justify-between gap-4">
            <h1 class="text-4xl md:text-5xl font-serif mb-4 italic">
              {p.name}
            </h1>
            <FavoriteButton productId={p.id} showText={true} client:load />
          </div>

          <div class="flex items-center gap-4">
            <p class="text-2xl font-medium text-brand-gold">
              {formatPrice(displayPrice)}
            </p>
            {
              originalPrice && (
                <p class="text-lg text-slate-400 line-through">
                  {formatPrice(originalPrice)}
                </p>
              )
            }
            {
              p.is_on_sale && originalPrice && (
                <span class="bg-red-100 text-red-600 px-2 py-1 text-xs font-bold rounded">
                  -{Math.round((1 - displayPrice / originalPrice) * 100)}%
                </span>
              )
            }
          </div>
        </div>

        <p class="text-slate-600 leading-relaxed italic mb-8">
          {p.description}
        </p>

        {
          p.material && (
            <div class="mb-6 text-sm">
              <span class="text-slate-500">Material:</span>
              <span class="ml-2 font-medium text-slate-700">{p.material}</span>
            </div>
          )
        }

        <!-- Componente de selección de talla y añadir al carrito -->
        <ProductDetail
          client:load
          productId={p.id}
          productName={p.name}
          productPrice={displayPrice}
          productImage={mainImage}
          availableSizes={p.sizes || []}
        />
      </div>
    </div>
  </div>
</PublicLayout>
