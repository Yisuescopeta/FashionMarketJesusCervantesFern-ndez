---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

export const prerender = false;

const { data: categories } = await supabase.from("categories").select("*");
---

<AdminLayout title="Añadir Producto">
  <div class="max-w-4xl">
    <form
      id="product-form"
      class="space-y-8 bg-white p-8 border border-slate-100 shadow-sm"
    >
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="space-y-2">
          <label
            class="text-[10px] uppercase tracking-widest font-bold text-slate-500"
            >Nombre del Producto</label
          >
          <input
            name="name"
            type="text"
            required
            class="w-full border-slate-200 p-3 focus:ring-brand-gold focus:border-brand-gold"
          />
        </div>
        <div class="space-y-2">
          <label
            class="text-[10px] uppercase tracking-widest font-bold text-slate-500"
            >Categoría</label
          >
          <select name="category_id" class="w-full border-slate-200 p-3">
            {
              categories?.map((cat) => (
                <option value={cat.id}>{cat.name}</option>
              ))
            }
          </select>
        </div>
      </div>

      <div class="space-y-2">
        <label
          class="text-[10px] uppercase tracking-widest font-bold text-slate-500"
          >Descripción</label
        >
        <textarea
          name="description"
          rows="4"
          class="w-full border-slate-200 p-3"></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="space-y-2">
          <label
            class="text-[10px] uppercase tracking-widest font-bold text-slate-500"
            >Precio (en céntimos)</label
          >
          <input
            name="price"
            type="number"
            step="1"
            required
            class="w-full border-slate-200 p-3"
            placeholder="Ej: 59900 para 599.00€"
          />
        </div>
        <div class="space-y-2">
          <label
            class="text-[10px] uppercase tracking-widest font-bold text-slate-500"
            >Stock Inicial</label
          >
          <input
            name="stock"
            type="number"
            required
            class="w-full border-slate-200 p-3"
          />
        </div>
      </div>

      <!-- Drag & Drop Area -->
      <div class="space-y-2">
        <label
          class="text-[10px] uppercase tracking-widest font-bold text-slate-500"
          >Imágenes (Drag & Drop)</label
        >
        <div
          id="drop-zone"
          class="border-2 border-dashed border-slate-200 p-12 text-center hover:border-brand-gold transition-colors cursor-pointer group"
        >
          <p class="text-slate-400 group-hover:text-brand-gold italic">
            Arrastra tus fotos aquí o haz clic para seleccionar
          </p>
          <input
            type="file"
            id="file-input"
            multiple
            class="hidden"
            accept="image/*"
          />
        </div>
        <div id="preview-grid" class="grid grid-cols-4 gap-4 mt-4"></div>
      </div>

      <button
        type="submit"
        class="w-full bg-brand-navy text-white py-4 font-bold uppercase tracking-widest text-sm hover:bg-black transition"
      >
        Guardar Producto
      </button>
    </form>
  </div>
</AdminLayout>

<script>
  import { supabase } from "../../../lib/supabase";
  import { slugify } from "../../../lib/utils";

  const form = document.getElementById("product-form") as HTMLFormElement;
  const dropZone = document.getElementById("drop-zone");
  const fileInput = document.getElementById("file-input") as HTMLInputElement;
  const previewGrid = document.getElementById("preview-grid");

  let uploadedFiles: File[] = [];

  dropZone?.addEventListener("click", () => fileInput.click());

  dropZone?.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("border-brand-gold");
  });

  dropZone?.addEventListener("dragleave", () => {
    dropZone.classList.remove("border-brand-gold");
  });

  dropZone?.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-brand-gold");
    const files = Array.from(e.dataTransfer?.files || []);
    handleFiles(files);
  });

  fileInput?.addEventListener("change", () => {
    const files = Array.from(fileInput.files || []);
    handleFiles(files);
  });

  function handleFiles(files: File[]) {
    uploadedFiles = [...uploadedFiles, ...files];
    renderPreviews();
  }

  function renderPreviews() {
    if (!previewGrid) return;
    previewGrid.innerHTML = "";
    uploadedFiles.forEach((file, index) => {
      const url = URL.createObjectURL(file);
      const div = document.createElement("div");
      div.className = "aspect-square bg-slate-100 relative";
      div.innerHTML = `<img src="${url}" class="w-full h-full object-cover" /><button type="button" class="absolute top-0 right-0 bg-red-500 text-white p-1 text-xs" onclick="window.removeImage(${index})">X</button>`;
      previewGrid.appendChild(div);
    });
  }

  (window as any).removeImage = (index: number) => {
    uploadedFiles.splice(index, 1);
    renderPreviews();
  };

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const name = formData.get("name") as string;
    const slug = slugify(name);

    // 1. Upload Images
    const imageUrls: string[] = [];
    for (const file of uploadedFiles) {
      const fileName = `${Date.now()}-${file.name}`;
      const { data, error } = await supabase.storage
        .from("products-images")
        .upload(fileName, file);

      if (data) {
        const {
          data: { publicUrl },
        } = supabase.storage.from("products-images").getPublicUrl(fileName);
        imageUrls.push(publicUrl);
      }
    }

    // 2. Insert Product
    const { error } = await supabase.from("products").insert({
      name,
      slug,
      description: formData.get("description"),
      price: parseInt(formData.get("price") as string),
      stock: parseInt(formData.get("stock") as string),
      category_id: formData.get("category_id"),
      images: imageUrls,
    });

    if (!error) {
      window.location.href = "/admin/productos";
    } else {
      alert("Error al guardar: " + error.message);
    }
  });
</script>
