---
import PublicLayout from "../layouts/PublicLayout.astro";
import { ShoppingBag } from "lucide-react";

export const prerender = false;
---

<PublicLayout title="Tu Carrito de Compra">
    <div class="max-w-4xl mx-auto px-6 py-24">
        <div class="text-center mb-16">
            <h2
                class="text-[10px] uppercase tracking-[0.4em] text-brand-gold font-bold mb-4"
            >
                Finalizar Compra
            </h2>
            <h1 class="text-5xl font-serif italic">Mi Selección</h1>
        </div>

        <div
            id="cart-container"
            class="bg-white border border-slate-100 shadow-sm p-8"
        >
            <!-- Logic handled by React/NanoStores below for reactivity -->
            <div id="cart-items-list" class="space-y-8">
                <!-- Rendered client-side for immediate feedback -->
            </div>

            <div id="cart-empty" class="hidden text-center py-12">
                <ShoppingBag
                    className="w-12 h-12 mx-auto text-slate-200 mb-4"
                />
                <p class="text-slate-400 italic">Tu selección está vacía.</p>
                <a
                    href="/productos"
                    class="inline-block mt-6 text-brand-gold font-bold uppercase tracking-widest text-xs hover:underline"
                    >Ir a la tienda</a
                >
            </div>

            <div
                id="cart-summary"
                class="mt-12 pt-8 border-t border-slate-100"
            >
                <!-- Mensaje de login requerido (oculto por defecto) -->
                <div id="login-required-msg" class="hidden mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg text-center">
                    <p class="text-amber-700 text-sm font-medium mb-2">
                        Debes iniciar sesión para completar tu compra
                    </p>
                    <a 
                        href="/login?redirect=/carrito" 
                        class="inline-block text-brand-gold font-bold text-xs uppercase tracking-widest hover:underline"
                    >
                        Iniciar Sesión →
                    </a>
                </div>
                
                <div class="flex justify-between items-end">
                    <div>
                        <p
                            class="text-xs uppercase tracking-widest text-slate-400 font-bold mb-1"
                        >
                            Total Estimado
                        </p>
                        <p id="total-price" class="text-3xl font-serif">0.00€</p>
                    </div>
                    <button
                        id="checkout-btn"
                        class="bg-brand-navy text-white px-12 py-4 font-bold uppercase tracking-widest text-sm hover:bg-black transition-all"
                    >
                        Tramitar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>
</PublicLayout>

<script>
    import {
        cartItems,
        cartTotal,
        removeCartItem,
        updateQuantity,
    } from "../stores/cart";
    import { formatPrice } from "../lib/utils";
    import { supabase } from "../lib/supabase";

    const itemsList = document.getElementById("cart-items-list");
    const emptyMsg = document.getElementById("cart-empty");
    const summary = document.getElementById("cart-summary");
    const totalPriceElem = document.getElementById("total-price");
    const loginRequiredMsg = document.getElementById("login-required-msg");
    const checkoutBtn = document.getElementById("checkout-btn") as HTMLButtonElement;

    let isAuthenticated = false;

    // Verificar autenticación al cargar
    async function checkAuth() {
        const { data: { user } } = await supabase.auth.getUser();
        isAuthenticated = !!user;
        updateAuthUI();
    }

    // Actualizar UI según estado de autenticación
    function updateAuthUI() {
        if (!isAuthenticated && cartItems.get().length > 0) {
            loginRequiredMsg?.classList.remove("hidden");
            if (checkoutBtn) {
                checkoutBtn.textContent = "Iniciar Sesión para Comprar";
            }
        } else {
            loginRequiredMsg?.classList.add("hidden");
            if (checkoutBtn) {
                checkoutBtn.textContent = "Tramitar Pedido";
            }
        }
    }

    // Manejar click en checkout
    checkoutBtn?.addEventListener("click", () => {
        if (!isAuthenticated) {
            window.location.href = "/login?redirect=/carrito";
        } else {
            // Aquí iría la lógica de procesamiento del pedido
            alert("¡Gracias por tu pedido! (Funcionalidad de pago en desarrollo)");
        }
    });

    function renderCart() {
        const items = cartItems.get();

        if (items.length === 0) {
            itemsList?.classList.add("hidden");
            summary?.classList.add("hidden");
            emptyMsg?.classList.remove("hidden");
            return;
        }

        itemsList?.classList.remove("hidden");
        summary?.classList.remove("hidden");
        emptyMsg?.classList.add("hidden");

        if (itemsList) {
            itemsList.innerHTML = items
                .map(
                    (item) => `
        <div class="flex items-center space-x-6">
          <div class="w-24 h-32 bg-slate-50 flex-shrink-0">
            <img src="${item.image}" alt="" class="w-full h-full object-cover" />
          </div>
          <div class="flex-1">
            <h3 class="font-serif text-xl italic">${item.name}</h3>
            <p class="text-slate-400 text-sm mb-4">${formatPrice(item.price)}</p>
            <div class="flex items-center space-x-4">
               <button onclick="window.updateQty('${item.id}', ${item.quantity - 1})" class="text-slate-400 hover:text-brand-navy">-</button>
               <span class="text-sm font-bold">${item.quantity}</span>
               <button onclick="window.updateQty('${item.id}', ${item.quantity + 1})" class="text-slate-400 hover:text-brand-navy">+</button>
            </div>
          </div>
          <button onclick="window.removeItem('${item.id}')" class="text-xs font-bold uppercase tracking-widest text-red-400 hover:text-red-600">Eliminar</button>
        </div>
      `,
                )
                .join("");
        }

        if (totalPriceElem) {
            totalPriceElem.textContent = formatPrice(cartTotal.get());
        }

        updateAuthUI();
    }

    // Bind to window for HTML onclick
    (window as any).removeItem = (id: string) => removeCartItem(id);
    (window as any).updateQty = (id: string, qty: number) =>
        updateQuantity(id, qty);

    // Inicializar
    checkAuth();
    cartItems.subscribe(renderCart);
    renderCart();
</script>
