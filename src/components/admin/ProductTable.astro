---
import { Package, Eye, Edit, Trash2, Zap } from "lucide-react";
import { formatPrice } from "../../lib/utils";

interface Props {
    products: any[];
}

const { products } = Astro.props;
---

<div
    class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden"
>
    <div class="overflow-x-auto">
        <table class="w-full text-left" id="products-table">
            <thead class="bg-slate-50 border-b border-slate-100">
                <tr>
                    <th
                        class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider"
                        >Producto</th
                    >
                    <th
                        class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider"
                        >Categoría</th
                    >
                    <th
                        class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider"
                        >Precio</th
                    >
                    <th
                        class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider"
                        >Stock</th
                    >
                    <th
                        class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider"
                        >Estado</th
                    >
                    <th
                        class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right"
                        >Acciones</th
                    >
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100" id="products-tbody">
                {
                    products?.map((product) => (
                        <tr
                            class="hover:bg-slate-50 transition-colors product-row"
                            data-name={product.name.toLowerCase()}
                            data-category={product.category_id}
                            data-stock={product.stock}
                        >
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0">
                                        {product.images?.[0] ? (
                                            <img
                                                src={product.images[0]}
                                                alt=""
                                                class="w-full h-full object-cover"
                                            />
                                        ) : (
                                            <div class="w-full h-full flex items-center justify-center">
                                                <Package className="w-6 h-6 text-slate-300" />
                                            </div>
                                        )}
                                    </div>
                                    <div>
                                        <p class="font-bold text-slate-800">
                                            {product.name}
                                        </p>
                                        <p class="text-xs text-slate-400 truncate max-w-[200px]">
                                            {product.description?.substring(
                                                0,
                                                50,
                                            )}
                                            ...
                                        </p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-700">
                                    {product.categories?.name ||
                                        "Sin categoría"}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div>
                                    <p class="font-bold text-slate-800">
                                        {formatPrice(product.price)}
                                    </p>
                                    {product.is_on_sale &&
                                        product.sale_price && (
                                            <p class="text-xs text-red-500 font-medium">
                                                Oferta:{" "}
                                                {formatPrice(
                                                    product.sale_price,
                                                )}
                                            </p>
                                        )}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span
                                    class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold ${
                                        product.stock === 0
                                            ? "bg-red-100 text-red-700"
                                            : product.stock < 10
                                              ? "bg-amber-100 text-amber-700"
                                              : "bg-emerald-100 text-emerald-700"
                                    }`}
                                >
                                    {product.stock} uds
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col gap-1">
                                    {product.is_active ? (
                                        <span class="inline-flex items-center text-xs text-emerald-600 font-medium">
                                            <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full mr-1.5" />
                                            Activo
                                        </span>
                                    ) : (
                                        <span class="inline-flex items-center text-xs text-slate-400 font-medium">
                                            <span class="w-1.5 h-1.5 bg-slate-300 rounded-full mr-1.5" />
                                            Inactivo
                                        </span>
                                    )}
                                    {product.is_on_sale && (
                                        <span class="inline-flex items-center text-xs text-orange-600 font-medium">
                                            <Zap className="w-3 h-3 mr-1" />
                                            En oferta
                                        </span>
                                    )}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex justify-end gap-2">
                                    <a
                                        href={`/productos/${product.slug}`}
                                        target="_blank"
                                        class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                        title="Ver en tienda"
                                    >
                                        <Eye className="w-4 h-4" />
                                    </a>
                                    <a
                                        href={`/admin/productos/${product.id}`}
                                        class="p-2 text-slate-400 hover:text-amber-600 hover:bg-amber-50 rounded-lg transition-colors"
                                        title="Editar"
                                    >
                                        <Edit className="w-4 h-4" />
                                    </a>
                                    <button
                                        class="delete-btn p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                        data-id={product.id}
                                        data-name={product.name}
                                        title="Eliminar"
                                    >
                                        <Trash2 className="w-4 h-4" />
                                    </button>
                                </div>
                            </td>
                        </tr>
                    ))
                }
                {
                    (!products || products.length === 0) && (
                        <tr>
                            <td colspan="6" class="px-6 py-16 text-center">
                                <Package className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                                <p class="text-slate-500 mb-4">
                                    No hay productos registrados
                                </p>
                                <a
                                    href="/admin/productos/nuevo"
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-amber-500 text-white rounded-lg font-medium text-sm hover:bg-amber-600 transition-colors"
                                >
                                    <div class="w-4 h-4">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="24"
                                            height="24"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            class="lucide lucide-plus-circle"
                                        >
                                            <>
                                                <circle
                                                    cx="12"
                                                    cy="12"
                                                    r="10"
                                                />
                                                <path d="M8 12h8" />
                                                <path d="M12 8v8" />
                                            </>
                                        </svg>
                                    </div>
                                    Añadir primer producto
                                </a>
                            </td>
                        </tr>
                    )
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    import { supabase } from "../../lib/supabase";

    // Eliminar producto
    document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
            const id = (btn as HTMLElement).dataset.id;
            const name = (btn as HTMLElement).dataset.name;

            if (
                confirm(
                    `¿Estás seguro de eliminar "${name}"? Esta acción no se puede deshacer.`,
                )
            ) {
                const { error } = await supabase
                    .from("products")
                    .delete()
                    .eq("id", id);
                if (!error) {
                    window.location.reload();
                } else {
                    alert("Error al eliminar: " + error.message);
                }
            }
        });
    });
</script>
